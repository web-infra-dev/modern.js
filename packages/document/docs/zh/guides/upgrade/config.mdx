# 配置变化

本篇文档主要介绍从 Modern.js 2.0 升级到 3.0 时，配置项层面的不兼容变更以及推荐的迁移方式。

## html

### html.appIcon

**变更内容**: 不再支持字符串形式，必须使用对象格式。

**V2 类型**:
```typescript
type AppIconItem = {
  src: string;
  size: number;
  target?: 'apple-touch-icon' | 'web-app-manifest';
};

type AppIcon = string | {
  name?: string;
  icons: AppIconItem[];
  filename?: string;
};
```

**V3 类型**:
```typescript
type AppIconItem = {
  src: string;
  size: number;
  target?: 'apple-touch-icon' | 'web-app-manifest';
};

type AppIcon = {
  name?: string;
  icons: AppIconItem[];
  filename?: string;
};
```

**迁移示例**:
```typescript
// v2
export default {
  html: {
    appIcon: './src/assets/icon.png',
  },
};

// v3
export default {
  html: {
    appIcon: {
      icons: [{
        src: './src/assets/icon.png',
        size: 180
      }]
    }
  },
};
```

### html.xxxByEntries

**变更内容**: `metaByEntries`、`templateParametersByEntries`、`injectByEntries`、`tagsByEnties`、`faviconByEntries`、`templateByEnties`、`titleByEntries` 等配置已废弃，需要使用函数语法代替。

**处理步骤**:
1. 移除相关配置
2. 使用 `html.xxx` 的函数用法代替

**迁移示例**:
```typescript
// v2
export default {
  html: {
    metaByEntries: {
      foo: {
        description: 'TikTok',
      },
      // 其他配置...
    },
  },
};

// v3
export default {
  html: {
    meta({ entryName }) {
      switch (entryName) {
        case 'foo':
          return {
            description: 'TikTok',
          };
        // 其他配置...
      }
    },
  },
};
```

### html.disableHtmlFolder

**变更内容**: 该配置已废弃，使用 `html.outputStructure` 代替。

**迁移示例**:
```typescript
// v2 - 等同于 html.outputStructure 配置为 nested
export default {
  html: {
    disableHtmlFolder: true,
  },
};

// v3
export default {
  html: {
    outputStructure: 'flat',
  },
};
```

## output

### output.overrideBrowserslist

**变更内容**: 需要根据项目现有配置情况处理。

**处理步骤**:
1. 检查项目中是否有 `.browserslistrc` 文件
2. 检查 `edenx.config.[ts|js]` 中是否配置了 `output.overrideBrowserslist`
3. 检查 package.json 中是否配置了 browserslist

如果都没有，则创建 `.browserslistrc` 文件，内容为支持 ES6 的浏览器：

```typescript
chrome >= 51
edge >= 15
firefox >= 54
safari >= 10
ios_saf >= 10
```

### output.enableAssetFallback

**变更内容**: 该配置已废弃，注释掉并添加说明。

```typescript
// 该配置已废弃，如有问题请咨询 oncall 解决
// output: {
//   enableAssetFallback: true,
// },
```

### output.cssModuleLocalIdentName

**变更内容**: 该配置已废弃，使用 `output.cssModules.localIdentName` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    cssModuleLocalIdentName: '[path][name]__[local]-[hash:base64:6]',
  },
};

// v3
export default {
  output: {
    cssModules: {
      localIdentName: '[path][name]__[local]-[hash:base64:6]',
    },
  },
};
```

### output.disableCssExtract

**变更内容**: 该配置已废弃，使用 `output.injectStyles` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    disableCssExtract: true,
  },
};

// v3
export default {
  output: {
    injectStyles: true,
  },
};
```

### output.disableFilenameHash

**变更内容**: 该配置已废弃，使用 `output.filenameHash` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    disableFilenameHash: true,
  },
};

// v3
export default {
  output: {
    filenameHash: false,
  },
};
```

### output.disableMinimize

**变更内容**: 该配置已废弃，使用 `output.minify` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    disableMinimize: true,
  },
};

// v3
export default {
  output: {
    minify: false,
  },
};
```

### output.disableSourceMap

**变更内容**: 该配置已废弃，使用 `output.sourceMap` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    disableSourceMap: true,
  },
};

// v3
export default {
  output: {
    sourceMap: false,
  },
};
```

### output.enableInlineScripts

**变更内容**: 该配置已废弃，使用 `output.inlineScripts` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    enableInlineScripts: true,
  },
};

// v3
export default {
  output: {
    inlineScripts: true,
  },
};
```

### output.enableInlineStyles

**变更内容**: 该配置已废弃，使用 `output.inlineStyles` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    enableInlineStyles: true,
  },
};

// v3
export default {
  output: {
    inlineStyles: true,
  },
};
```

### output.enableLatestDecorators

**变更内容**: 该配置已废弃，使用 `source.decorators` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    enableLatestDecorators: true,
  },
};

// v3
export default {
  source: {
    decorators: {
      version: '2022-03',
    },
  },
};
```

### output.disableNodePolyfill

**变更内容**: 该配置已废弃，通过注册 `pluginNodePolyfill` 代替。

**迁移示例**:
```typescript
// v2
export default {
  output: {
    disableNodePolyfill: false,
  },
};

// v3
import { pluginNodePolyfill } from "@rsbuild/plugin-node-polyfill";
export default {
  builderPlugins: [
    pluginNodePolyfill()
  ]
};
```

## source

### source.resolveMainFields

**变更内容**: 该配置已废弃，使用 `resolve.mainFields` 代替。

**迁移示例**:
```typescript
// v2
source: {
  resolveMainFields: ['custom', 'module', 'main']
}

// v3
resolve: {
  mainFields: ['custom', 'module', 'main']
}
```

### source.resolveExtensionPrefix

**变更内容**: 该配置已废弃，使用 `resolve.extensions` 代替。

**迁移示例**:
```typescript
// v2
source: {
  resolveExtensionPrefix: ['.ts', '.tsx', '.js']
}

// v3
resolve: {
  extensions: ['.ts', '.tsx', '.js']
}
```

### source.moduleScopes

**变更内容**: 该配置已废弃，直接移除。

### source.enableCustomEntry

**变更内容**: 该配置已废弃，直接移除。

## tools

### tools.esbuild

**变更内容**: 该配置已废弃，需要手动切换到 esbuild 压缩。

```typescript
// 该配置已废弃，请参考 [切换压缩器](https://rsbuild.rs/zh/config/output/minify#%E5%88%87%E6%8D%A2%E5%8E%8B%E7%BC%A9%E5%99%A8) 来手动切换到 esbuild 压缩
// tools: {
//   esbuild: { /* 配置 */ }
// },
```

### tools.terser

**变更内容**: 该配置已废弃，需要手动切换到 Terser 压缩。

```typescript
// 该配置已废弃，请参考 [切换压缩器](https://rsbuild.rs/zh/config/output/minify#%E5%88%87%E6%8D%A2%E5%8E%8B%E7%BC%A9%E5%99%A8) 来手动切换到 Terser 压缩
// tools: {
//   terser: { /* 配置 */ }
// },
```

### tools.devServer

**变更内容 1**: `after`、`before`、`devMiddleware` 配置已废弃，使用 `dev` 配置代替。

**迁移示例**:
```typescript
// v2
export default {
  tools: {
    devServer: {
      before: [...],
      after: [...],
      devMiddleware: {
        writeToDisk: true
      }
    }
  }
};

// v3
export default {
  dev: {
    setupMiddlewares: [...],
    writeToDisk: true
  }
};
```

**变更内容 2**: `client`、`https`、`liveReload` 配置已废弃，使用对应的 `dev.client`、`dev.https`、`dev.liveReload` 配置代替。

**迁移示例**:
```typescript
// v2
export default {
  tools: {
    devServer: {
      client: {
        port: 8081
      }
    }
  }
};

// v3
export default {
  dev: {
    client: {
      port: 8081
    }
  }
};
```

**变更内容 3**: `hot` 配置已废弃，使用 `dev.hmr` 配置代替。

**迁移示例**:
```typescript
// v2
export default {
  tools: {
    devServer: {
      hot: false
    }
  }
};

// v3
export default {
  dev: {
    hmr: false
  }
};
```

## dev

### dev.port

**变更内容**: 该配置已被移除，改为 `server.port`。

**迁移示例**:
```typescript
// 改动前
dev: {
  port: 8080
}

// 改动后
server: {
  port: process.env.NODE_ENV === 'development' && 8080
}
```

## runtime

### runtime.router

**变更内容**: 不再需要，可以直接移除。

### runtime.state

**变更内容**: 该配置被废弃，建议使用第三方状态管理库。

## experiments

### experiments.lazyCompilation

**变更内容**: 该配置已废弃，改为 `dev.lazyCompilation`。

**迁移示例**:
```typescript
// v2
experiments: {
  lazyCompilation: true
}

// v3
dev: {
  lazyCompilation: true
}
```

## plugins

### autoLoadPlugins

**变更内容**: 该配置已被废弃，需要手动注册插件。

**处理步骤**:
1. 移除 `autoLoadPlugins` 配置
2. 手动导入并注册需要使用的插件

**支持的插件变量名**:
- `@edenx/app-tools`: `appTools`
- `@edenx/plugin-slardar-web`: `slardarWebPlugin`
- `@edenx/plugin-i18n`: `i18nPlugin`
- `@edenx/plugin-starling-intl`: `starlingIntlPlugin`
- `@edenx/plugin-bff`: `bffPlugin`
- `@edenx/plugin-gulu`: `guluPlugin`
- `@edenx/plugin-gulux`: `guluxPlugin`
- `@edenx/plugin-ssg`: `ssgPlugin`
- `@edenx/plugin-garfish`: `garfishPlugin`

**迁移示例**:
```typescript
// v2 - 自动加载插件
export default {
  autoLoadPlugins: true
}

// v3 - 手动注册插件
import { defineConfig, appTools } from '@edenx/app-tools';
import { i18nPlugin } from '@edenx/plugin-i18n';
import { ssgPlugin } from '@edenx/plugin-ssg';

export default defineConfig({
  plugins: [
    appTools(),
    i18nPlugin(),
    ssgPlugin()
  ]
})
```

### app-tools 插件

**变更内容**: 该插件不需要传入任何参数。

**迁移示例**:
```typescript
// v2
plugins: [
  appTools({
    bundler: 'rspack'
  })
],

// v3
plugins: [
  appTools()
],
```

### plugin-gecko

**变更内容**: 按以下步骤处理

**处理步骤**:
1. 检测 `edenx.config.[tj]s` 中是否有注册 `@edenx/plugin-gecko`
2. 如果有，将 gecko 插件的注册相关代码移除或注释
3. 添加注释说明直接使用 gecko 原子服务

**迁移示例**:
```typescript
// 移除 gecko 插件注册代码
// 请直接使用 gecko 原子服务 [Gecko 原子服务用户文档](https://bytedance.larkoffice.com/wiki/GQgHwQpubiAksVkWDnwcgeRjn8c)
// import { geckoPlugin } from '@edenx/plugin-gecko';
// plugins: [
//   geckoPlugin()
// ],
```

## performance

### performance.transformLodash

**变更内容**: 不再需要，可以直接移除。

**迁移示例**:
```typescript
// v2
export default {
  performance: {
    transformLodash: true
  }
}

// v3 - 直接移除该配置
export default {
  // 配置...
}
```

## 升级检查清单

在完成升级后，请检查以下项目：

### 配置文件检查

- [ ] 移除所有废弃的配置项
- [ ] 更新为新的配置结构
- [ ] 手动注册必要的插件
- [ ] 检查 `.browserslistrc` 文件是否存在

### 插件检查

- [ ] 移除 `autoLoadPlugins` 配置
- [ ] 手动导入并注册所有需要的插件
- [ ] 更新插件参数（如 appTools 不需要参数）
- [ ] 移除 gecko 插件注册

### 开发环境检查

- [ ] 验证开发服务器启动正常
- [ ] 检查 HMR 功能是否正常
- [ ] 确认端口配置正确
- [ ] 测试中间件配置

### 构建检查

- [ ] 验证生产构建成功
- [ ] 检查 CSS 提取和压缩
- [ ] 确认文件名哈希配置
- [ ] 验证代码压缩配置

### 运行时检查

- [ ] 确认路由功能正常
- [ ] 检查状态管理是否需要调整
- [ ] 验证懒加载功能

## 常见问题

### Q: 升级后项目无法启动怎么办？

A: 首先检查配置文件中的废弃项是否已经移除，然后检查插件是否已经正确注册。可以查看控制台错误信息来定位具体问题。

### Q: 如何处理旧的 tools.esbuild 配置？

A: 需要根据 [切换压缩器](https://rsbuild.rs/zh/config/output/minify#%E5%88%87%E6%8D%A2%E5%8E%8B%E7%BC%A9%E5%99%A8) 文档手动配置压缩器。

### Q: 插件注册后仍然不生效？

A: 确认插件已经正确导入和注册，并且插件版本与 EdenX 3.0 兼容。

### Q: 如何处理废弃的性能优化配置？

A: 大部分性能优化配置已经被废弃或移到了其他地方，参考上述文档进行迁移，或考虑使用 Rspack 的原生优化功能。


