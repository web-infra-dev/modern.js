# 生命周期

import Mermaid from '@site/src/components/Mermaid';

<Mermaid>
{`
flowchart TD
    init{{"Server 初始化"}}
    load_config(加载用户配置文件)
    server_plugin(加载 Server 插件<br><sub>配置文件中注册的插件<br>CLI 插件注册的 Server 插件<br>插件中使用的插件</sub>)
    registry_hooks(注册 Hooks 函数<br><sub>执行插件 setup 函数，注册插件中定义的 Hook, 插件 setup 中逻辑也会在这里执行</sub>)

    modifyConfig(modifyConfig<br><sub>修改服务器配置</sub>)
    onPrepare(onPrepare<br><sub>在服务器完成配置校验之后，应用中间件之前执行</sub>)
    apply_middlewares(应用中间件<br><sub>按照 order 和 before 规则应用中间件</sub>)

    init --> load_config
    load_config --> server_plugin
    server_plugin --> registry_hooks
    registry_hooks --> modifyConfig
    modifyConfig --> onPrepare
    onPrepare --> apply_middlewares

    style init fill:#FDE68A,font-size:10px;
    style load_config stroke-dasharray:5 5,fill:#86EFAC,font-size:10px;
    style server_plugin stroke-dasharray:5 5,fill:#86EFAC,font-size:10px;
    style registry_hooks stroke-dasharray:5 5,fill:#9CA3AF,font-size:10px;
    style modifyConfig font-size:10px;
    style onPrepare font-size:10px;
    style apply_middlewares font-size:10px;
`}
</Mermaid>

:::info

**运行时钩子**

`onReset` 钩子在运行时触发，当文件发生变化或需要代码重新编译(Rspack)完成时会被调用。它不属于初始化流程，因此未在上图中展示。

- **触发时机**：文件变化（`event.type: 'file-change'`）或代码重新编译(Rspack)完成（`event.type: 'repack'`）
- **使用场景**：清理缓存、重新初始化资源等

:::
