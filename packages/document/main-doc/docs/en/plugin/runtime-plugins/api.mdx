# Plugin API

Modern.js's Runtime Plugins allow you to extend and modify the behavior of your application during its React code execution.  With Runtime Plugins, you can easily perform initialization tasks, implement React Higher-Order Component (HOC) wrapping, and more.

## Plugin Structure

A typical Runtime Plugin looks like this:

```ts
import type { RuntimePluginFuture } from '@modern-js/runtime';

const myRuntimePlugin = (): RuntimePluginFuture => ({
  name: 'my-runtime-plugin',
  setup: (api) => {
    // Use the api to register hooks
    api.onBeforeRender((context) => {
      console.log('Before rendering:', context);
    });

    api.wrapRoot((App) => {
      return (props) => (
        <MyContextProvider>
          <App {...props} />
        </MyContextProvider>
      );
    });
  },
});

export default myRuntimePlugin;

```

-   `name`:  A unique identifier for the plugin.
-   `setup`: The main logic of the plugin, which receives an `api` object as a parameter, used to register hooks.

## API Overview

The Runtime Plugin API is primarily divided into the following categories:

-   **Information Retrieval**:  Getting runtime configurations and hook functions.
-   **Lifecycle Hooks**:  Executing custom logic at different stages of the application's rendering process.

### Information Retrieval

#### `getRuntimeConfig`

Retrieves the user-defined runtime configuration specified in the `modern.runtime.ts` file.

-   **Usage**:

```ts
const config = api.getRuntimeConfig();
console.log(config.myCustomSetting);
```

-   **Notes**:
    -   This method returns a *copy* of the user's configuration.  Modifying the return value will not affect the original configuration.

#### `getHooks`

Retrieves hook functions that can be manually triggered.

- **Type**:

```ts
() => {
  onBeforeRender: { call: (context: any) => Promise<void> };
  // Other hooks...
};
```

-   **Usage**:

```ts
const hooks = api.getHooks();
await hooks.onBeforeRender.call(myContext);
```

### Lifecycle Hooks

#### `onBeforeRender`

Executes before the application renders (including both server-side rendering and client-side rendering). You can use this hook to perform data prefetching, modify the rendering context, and so on.

-   **Type**:

    ```ts
    type OnBeforeRenderFn<RuntimeContext> = (context: RuntimeContext) => Promise<void> | void;
    ```
    `RuntimeContext` contains contextual information about the current request, such as the request object, response object, etc.

-   **Usage**:

    ```ts
    api.onBeforeRender(async (context) => {
      const data = await fetchData(context.req);
      context.data = data; // Add data to the context
    });
    ```

-   **Notes**:
    -   This hook is executed before *every* render, so avoid performing long-running operations.
    -   You can modify the `context` object within this hook, and the modified `context` will be passed to subsequent rendering processes.

#### `wrapRoot`

Allows you to wrap the application's root component with a custom React component. This is commonly used to add global Providers, layout components, etc.

-   **Type**:

    ```ts
    type WrapRootFn = (
      App: React.ComponentType<any>
    ) => React.ComponentType<any>;
    ```

-   **Usage**:

    ```ts
    api.wrapRoot((App) => {
      const AppWrapper = (props) => {
        return (
          <MyGlobalProvider>
            <Layout>
              <App {...props} /> {/* Ensure props are passed */}
            </Layout>
          </MyGlobalProvider>
        );
      };
      return AppWrapper;
    });
    ```

-   **Notes**:
    -   **It is crucial to pass the `props` to the original `App` component**, otherwise, the application may not function correctly.
    -   The component returned by `wrapRoot` is re-created on every render, so avoid defining complex logic or state within it.

## Advanced Usage

### Combining Hooks

You can combine multiple hooks to implement more complex functionality. For example, you can use `onBeforeRender` to fetch data and then use `wrapRoot` to pass the data to the entire application via Context:

```ts
api.onBeforeRender(async (context) => {
  const data = await fetchData(context.req);
  context.data = data;
});

api.wrapRoot((App) => {
  return (props) => (
    <DataContext.Provider value={props.data}>
      <App {...props} />
    </DataContext.Provider>
  );
});
```
