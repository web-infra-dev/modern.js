---
sidebar_position: 2
title: 体验微前端
---
# 体验微前端

通过本章你可以了解到：

- 如何创建微前端项目的主应用、子应用。
- 微前端项目开发的基本流程。

## 创建应用
目前支持两种路由模式
- 自控式路由
- 约定式路由

所以在这次的实践中，我们需要创建四个应用，分别为 2 个主应用，2 个子应用(业务中根据需要创建)：

- MainConvention 主应用(约定式路由)
- MainCustom 主应用(自控式路由)
- SubConvention 子应用(约定式路由)
- SubCustom 子应用(自控式路由)

### 创建约定式路由主应用

通过命令行工具初始化项目：

```bash
mkdir mainConvention && cd mainConvention
npx @modern-js/create
```

import DefaultMWAGenerate from "@site-docs/components/default-mwa-generate";

<DefaultMWAGenerate />

完成项目创建后我们可以通过 `pnpm run new` 来开启 `微前端` 功能：

```bash
? 请选择你想要的操作 启用可选功能
? 启用可选功能 启用「微前端」模式
```

接下来，让我们注册微前端插件并添加开启微前端主应用，并增加子应用列表：

import EnableMicroFrontend from "@site-docs/components/enable-micro-frontend";

<EnableMicroFrontend />

然后我们在 routes 文件夹下新建两个目录
- SubConvention (用于加载约定式路由子应用)
- SubCustom (用于加载自控式路由子应用)

在这两个目录下我们需要新建一个 `$.tsx` 文件作为主应用约定式路由的入口($ 代表模糊匹配，即 `/SubConvention` 和 `/SubConvention/test` 都会匹配到这个 `$.tsx` 作为该路由的入口文件，这会保证在微前端场景下正确加载子应用路由)

#### 加载约定式路由子应用
```js title="src/routes/SubConvention/$.tsx"
import { useModuleApps } from '@modern-js/plugin-garfish/runtime';

const Index = () => {
  const { SubConvention } = useModuleApps();

  return (
    <div>
      <SubConvention />
    </div>
  )
}

export default Index;
```

#### 加载自控式路由子应用
```js title="src/routes/SubCustom/$.tsx"
import { useModuleApps } from '@modern-js/plugin-garfish/runtime';

const Index = () => {
  const { SubCustom } = useModuleApps();

  return (
    <div>
      <SubCustom />
    </div>
  )
}

export default Index;
```
#### 路由跳转
此时主应用配置已经完成，通过路由即可加载子应用，修改主应用的 `layout.tsx` 来跳转路由
```js title="src/route/layout.tsx"
import { Outlet, Link } from '@modern-js/runtime/router';

const Layout = () => (
  <div>
    <div><Link to={'/SubConvention'}>加载约定式路由子应用</Link></div>
    <div><Link to={'/SubCustom'}>加载自控式路由子应用</Link></div>
    <div><Link to={'/'}>卸载子应用</Link></div>
    <Outlet />
  </div>
);

export default Layout;
```

### 创建自控式路由主应用

通过命令行工具初始化项目：

```bash
mkdir mainCustom && cd mainCustom
npx @modern-js/create
```

<DefaultMWAGenerate />

完成项目创建后我们可以通过 `pnpm run new` 来开启 `微前端` 功能：

```bash
? 请选择你想要的操作 启用可选功能
? 启用可选功能 启用「微前端」模式
```

接下来，让我们注册微前端插件并添加开启微前端主应用，并增加子应用列表：

<EnableMicroFrontend />

由于是自控式路由，我们删除掉 `routes` 文件夹并在 `src` 目录下增加 `App.tsx` 文件，此处如果使用的 `非 MApp` 组件，需要通过 `React Router v6` 的 `createBrowserRouter` API 来创建路由
#### 加载子应用
import CustomRouterMicroFrontend from "@site-docs/components/custom-router-micro-frontend";

<CustomRouterMicroFrontend />

### 创建约定式路由子应用

通过命令行工具初始化项目：

```bash
mkdir subConvention && cd subConvention
npx @modern-js/create
```

按照如下选择，生成项目：

<DefaultMWAGenerate/>

我们执行 `pnpm run new` 来开启 `微前端` 功能：

```bash
? 请选择你想要的操作 启用可选功能
? 启用可选功能 启用「微前端」模式
```

接下来，让我们注册微前端插件并修改 `modern.config.ts`，添加微前端子应用的配置 `deploy.microFrontend`：

```js title="modern.config.ts"
import appTools, { defineConfig } from '@modern-js/app-tools';
import garfishPlugin from '@modern-js/plugin-garfish';

export default defineConfig({
  dev: {
    port: 3002
  },
  runtime: {
    router: true,
    state: true,
  },
  deploy: {
    microFrontend: true,
  },
  plugins: [appTools(), garfishPlugin()],
});
```

添加 `src/routes/page.tsx` 代码
```js title="src/routes/page.tsx"
const Index = () => {
  return (
    <div className="container-box">subApp: 约定式路由的子应用的根路由</div>
  )
}

export default Index;
```

### 创建自控式路由子应用

通过命令行工具初始化项目：

```bash
mkdir subCustom && cd subCustom
npx @modern-js/create
```

按照如下选择，生成项目：

<DefaultMWAGenerate/>

我们执行 `pnpm run new` 来开启 `微前端`：

```bash
? 请选择你想要的操作 启用可选功能
? 启用可选功能 启用「微前端」模式
```

接下来，让我们注册微前端插件并修改 `modern.config.ts`，添加微前端子应用的配置 `deploy.microFrontend`：

```js title="modern.config.ts"
import appTools, { defineConfig } from '@modern-js/app-tools';
import garfishPlugin from '@modern-js/plugin-garfish';

export default defineConfig({
  dev: {
    port: 3003
  },
  runtime: {
    router: true,
    state: true,
  },
  deploy: {
    microFrontend: true,
  },
  plugins: [appTools(), garfishPlugin()],
});
```

自控式路由子应用需要手动在 `src/App.tsx` 添加代码，注意需要从 `props` 中解析并传递 `basename` 给 `BrowserRouter`

```js title="App.tsx"
import { BrowserRouter, Route, Routes } from '@modern-js/runtime/router';

export default (props: {basename: string}) => {
  const { basename } = props;

  return (
    <BrowserRouter basename={basename}>
      <Routes>
        <Route index element={<div>自控式路由子应用根路由</div>} />
        <Route path={'path'} element={<div>自控式路由子应用子路由</div>} />
      </Routes>
    </BrowserRouter>
  );
};
```

## 调试
按顺序在目录执行 `pnpm run dev` 命令启动应用：
- mainConvention 主应用(约定式路由) `http://localhost:8080`
- mainCustom 主应用(自控式路由) `http://localhost:8081`
- subConvention 子应用(约定式路由) `http://localhost:3002`
- subCustom 子应用(自控式路由) `http://localhost:3003`

访问主应用地址 `http://localhost:8080` 或 `http://localhost:8081`

在完成了微前端整体开发流程的体验后，你可以进一步了解如何 [开发主应用](/guides/topic-detail/micro-frontend/c03-main-app)

## 常见问题

自查手册: https://www.garfishjs.org/issues/
